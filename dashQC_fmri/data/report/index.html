<!DOCTYPE html>
<html>

<head>

    <title>Report on fMRI Registration</title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <!-- Styles for this page -->
    <style>

        /* Images tab styles */
        .montage {

            position: relative;
            left: 0;
        }

        /*@keyframes flickerAnimation {

            from { opacity: 1; }
            to { opacity: 0; }
        }

        .register {

            display: inline-block;
        }
        .register img{

            animation: flickerAnimation 1s infinite alternate ease-in-out;
        }*/

        @keyframes flickerAnimation {

            from { opacity: 1; }
            to { opacity: 0;}
        }

        .register {

            display: inline-block;
        }
        .register img:hover {

            /*animation: flickerAnimation 1s infinite alternate ease-in-out;*/
            animation-name: flickerAnimation;
            animation-duration: 1s;
            animation-iteration-count: 1;
            animation-direction: normal;
            animation-timing-function: ease-in-out;
            animation-fill-mode: both;
        }

        .group-image {

            text-align: center;
        }

        /* DataTables overrides */

        /* Search box */
        .input-sm {

            font-weight: lighter;
            font-size: 1em !important;
        }

        /* Pagination */
        li.paginate_button {

            display: inline !important;
            margin: 0 !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
            position: sticky !important;
            border: none !important;
            background: none !important;
        }
        li.paginate_button a {

            color: #3D4A56 !important;
        }
        li.paginate_button.active a {

            background-color: #3D4A56 !important;
            border-color: #3D4A56 !important;
            color: white !important;
        }
        table {

            display: inline-table !important;
            /*width: 100%;*/
        }

        /* Row select highlight color */
        tr.even.selected {
            background-color: #FFDD57 !important;
        }
        tr.odd.selected {
            background-color: #FFDD57 !important;
        }
        tr.even.selected > .sorting_1 {
            background-color: #FFDD57 !important;
        }
        tr.odd.selected > .sorting_1 {
            background-color: #FFDD57 !important;
        }

        /* Column select highlight color */
        tr.even > .sorting_1:not(.st-row-nohighlight) {
            background-color: #FFDD57 !important;
        }
        tr.odd > .sorting_1:not(.st-row-nohighlight) {
            background-color: #FFDD57 !important;
        }
        .sorting_asc:not(.st-column-nohighlight) {
            background-color: #FFDD57 !important;
        }
        .sorting_desc:not(.st-column-nohighlight) {
            background-color: #FFDD57 !important;
        }
        .footer-highlight {
            background-color: #FFDD57 !important;
        }

        /* Content specific */

        /* Group Images */
        .group-images-column-left {

            margin-left: 1.5em;
            margin-right: 0.5em;
        }
        .group-images-column-right {

            margin-left: 0.5em;
            margin-right: 1.5em;
        }

        /* Provenance */
        .provenance-column {

            margin-left: 1.5em;
            margin-right: 1.5em;
        }
        .provenance-column-left {

            margin-left: 1.5em;
            margin-right: 0.5em;
        }
        .provenance-column-right {

            margin-left: 0.5em;
            margin-right: 1.5em;
        }

    </style>

    <!-- Stylesheets -->


    <!-- Bootstrap -->
    <link rel="stylesheet" type="text/css" href="lib/bootstrap/bootstrap.min.css" />

    <!-- Keen.io -->
    <link rel="stylesheet" type="text/css" href="lib/keen/keen-dashboards.css" />

    <!-- pretty-json -->
    <link rel="stylesheet" type="text/css" href="lib/pretty-json/pretty-json.css" />

    <!-- select2 -->
    <link rel="stylesheet" type="text/css" href="lib/select2/select2.min.css"  />

    <!-- c3.js -->
    <link rel="stylesheet" type="text/css" href="lib/c3js/c3.min.css" />

    <!-- DataTables -->
    <link rel="stylesheet" type="text/css" href="lib/datatables/styles/jquery.dataTables.min.css"/>

    <!-- Desired table features:

        - Column sorting
        - Checkability for rows
        - Column click select event
        - Row click select event

    -->

    <!-- General styles for the dashboard -->
    <link rel="stylesheet" type="text/css" href="assets/general/css/qc_dash.css" />

</head>


<body class="application">

    <!-- Navbar -->
    <div class="navbar navbar-inverse navbar-fixed-top" role="navigation">

        <div class="container-fluid">

            <!-- Navbar header -->
            <div class="navbar-header">

                <!-- Creates a dropdown menu from an icon when the browser window
                     is too small to show the full navbar -->
                <button type="button" class="navbar-toggle" data-toggle="collapse"
                        data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>

                <!-- NIAK Brand -->
                <a class="navbar-brand" href="https://dashqc-fmri.readthedocs.io/en/latest/index.html">
                    dashQC_fmri
                </a>

            </div>

            <!-- Navbar body -->
            <div class="navbar-collapse collapse">

                <ul class="nav navbar-nav navbar-left">

                    <li class="navbar_item navbar-brand-current"><a href="index.html">Summary</a></li>
                    <li class="navbar_item"><a href="registration.html">Registration</a></li>
                    <li class="navbar_item"><a href="motion.html">Motion</a></li>

                </ul>

            </div>

        </div>

    </div>


    <!-- Contents -->
    <div class="container-fluid">

        <!-- Pills -->
        <ul class="nav nav-pills">

            <li class="active">
                <a data-toggle="pill" id="pill-registration-stats" href="#summary-registration-stats">Registration Stats</a>
            </li>
            <li>
                <a data-toggle="pill" id="pill-motion-stats" href="#summary-motion-stats">Motion Stats</a>
            </li>
            <li>
                <a data-toggle="pill" id="pill-group-images" href="#summary-images">Group Images</a>
            </li>
            <li>
                <a data-toggle="pill" id="pill-provenance" href="#summary-provenance">Provenance Information</a>
            </li>

        </ul>

        <!-- Pill tabs -->
        <div class="tab-content">

            <!-- Registration statistics tab -->
            <div class="tab-pane fade in active" id="summary-registration-stats">

                <!-- Selected chart -->
                <div class="row">

                    <div class="col-sm-1"></div>
                    <div class="col-sm-10">

                        <div class="chart-wrapper">

                            <div class="chart-title" id="chart-title-registration"></div>

                            <div class="chart-stage" id="chart-stage-registration">
                                <div id="chart-registration"></div>
                            </div>

                            <div class="chart-notes" id="chart-notes-registration"></div>

                        </div>

                    </div>
                    <div class="col-sm-1"></div>

                </div>

                <!-- Subject table -->
                <div class="row">

                    <div class="col-sm-1"></div>
                    <div class="col-sm-10">

                        <div class="chart-wrapper">

                            <div class="chart-title" id="chart-title-registration-table">Subjects</div>

                            <!-- display == table table-striped table-bordered  -->
                            <table id="subjectTable" class="display compact"></table>

                        </div>

                    </div>
                    <div class="col-sm-1"></div>

                </div>

            </div>

            <!-- Motion statistics tab -->
            <div class="tab-pane" id="summary-motion-stats">

                <!-- Selected chart -->
                <div class="row">

                    <div class="col-sm-1"></div>
                    <div class="col-sm-10">

                        <div class="chart-wrapper">

                            <div class="chart-title" id="chart-title-motion"></div>

                            <div class="chart-stage" id="chart-stage-motion">
                                <div id="chart-motion" style="width:95%"></div>
                            </div>

                            <div class="chart-notes" id="chart-notes-motion"></div>

                        </div>

                    </div>
                    <div class="col-sm-1"></div>

                </div>

                <!-- Run table -->
                <div class="row">

                    <div class="col-sm-1"></div>
                    <div class="col-sm-10">

                        <div class="chart-wrapper">

                            <div class="chart-title" id="chart-title-motion-table">Runs</div>

                            <!-- display == table table-striped table-bordered  -->
                            <table id="runTable" class="display compact"> </table>

                        </div>

                    </div>
                    <div class="col-sm-1"></div>

                </div>

            </div>

            <!-- Group images tab -->
            <div class="tab-pane fade" id="summary-images">

                <div class="row row-eq-height">

                    <!-- Group average T1 vs T1 template -->
                    <div class="col-sm-6 group-images-column-left">

                        <div class="chart-wrapper">

                            <div class="chart-title">T1 group average vs T1 template</div>

                            <div class="chart-stage group-image">

                                <div id="T1-groupVsTemplate" class="register" style="background-image: url('assets/group/images/template_stereotaxic_raw.png'); width: 80%; background-size: 80%; background-repeat: no-repeat; background-position: 50% 0%;">
                                    <img id="registration" class="montage" src="assets/group/images/average_t1_stereotaxic.png" width="80%" />
                                </div>

                            </div>

                            <div class="chart-notes">Hover mouse over image for comparison image. Move mouse away to reset to original image.</div>

                        </div>

                    </div>

                    <!-- BOLD group average vs T1 group average -->
                    <div class="col-sm-6 group-images-column-right">

                        <div class="chart-wrapper">

                            <div class="chart-title">BOLD group average vs T1 group average</div>

                            <div class="chart-stage group-image">

                                <div id="boldVsT1" class="register" style="background-image: url('assets/group/images/average_t1_stereotaxic.png'); width: 80%; background-size: 80%; background-repeat: no-repeat; background-position: 50% 0%">
                                    <img id="registration" class="montage" src="assets/group/images/average_func_stereotaxic.png" width="80%" />
                                </div>

                            </div>

                            <div class="chart-notes">Hover mouse over image for comparison image. Move mouse away to reset to original image.</div>

                        </div>

                    </div>

                </div>

                <div class="row row-eq-height">

                    <!-- Group BOLD mask vs T1 group average -->
                    <div class="col-sm-6 group-images-column-left">

                        <div class="chart-wrapper">

                            <div class="chart-title">BOLD group mask vs T1 group average</div>

                            <div class="chart-stage group-image">

                                <div id="groupMaskVsT1" class="register" style="background-image: url('assets/group/images/average_t1_stereotaxic.png'); width: 80%; background-size: 80%; background-repeat: no-repeat; background-position: 50% 0%">
                                    <img id="registration" class="montage" src="assets/group/images/mask_func_group_stereotaxic.png" width="80%" />
                                </div>

                            </div>

                            <div class="chart-notes">Hover mouse over image for comparison image. Move mouse away to reset to original image.</div>

                        </div>

                    </div>

                    <div class="col-sm-6 group-images-column-right">

                        <div class="chart-wrapper">

                            <div class="chart-title">BOLD average of individual masks vs T1 group average</div>

                            <div class="chart-stage group-image">

                                <div id="avgMaskVsT1" class="register" style="background-image: url('assets/group/images/average_t1_stereotaxic.png'); width: 80%; background-size: 80%; background-repeat: no-repeat; background-position: 50% 0%">
                                    <img id="registration" class="montage" src="assets/group/images/average_mask_func_stereotaxic.png" width="80%" />
                                </div>

                            </div>

                            <div class="chart-notes">Hover mouse over image for comparison image. Move mouse away to reset to original image.</div>

                        </div>

                    </div>

                </div>

            </div>

            <!-- Provenance tab -->
            <div class="tab-pane fade" id="summary-provenance">

                <div class="row row-eq-height">

                    <!-- Pipeline overview -->
                    <div class="col-sm-6 provenance-column-left">

                        <div class="chart-wrapper">

                            <div class="chart-title">Pipeline overview</div>

                            <div class="chart-stage">
                                <div id="pipeSummary"></div>
                            </div>

                            <div class="chart-notes"></div>

                        </div>

                    </div>

                    <!-- Input files for subject -->
                    <div class="col-sm-6 provenance-column-right">

                        <div class="chart-wrapper">

                            <div class="chart-title">
                                Input files for subject
                                <select class="select-subject" style="width: 50%"></select>
                            </div>

                            <div class="chart-stage">
                                <div id="prov-subject-files-json"></div>
                            </div>

                            <div class="chart-notes">
                                Click on {...} to collapse.
                            </div>

                        </div>

                    </div>

                </div>

                <div class="row row-eq-height">

                    <!-- Pipeline options -->
                    <div class="col-sm-12 provenance-column">

                        <div class="chart-wrapper">

                            <div class="chart-title">Pipeline options</div>

                            <div class="chart-stage">
                                <div id="prov-pipeline-options-json"></div>
                            </div>

                            <div class="chart-notes">Click on {...} to collapse.</div>

                        </div>

                    </div>

                </div>

            </div>

        </div>

    </div>

    <hr />

    <!-- Footer -->
    <footer class="footer">

        <div class="container-fluid">

            <div class="row row-eq-height">

                <div class="col-sm-12">

                    <p class="small text-muted">Dashboard built with &#9829; by <a href="http://simexp-lab.org">SIMEXP Lab.</a></p>

                </div>

            </div>

        </div>

    </footer>

    <!-- JS Dependencies -->

    <!-- jQuery -->
    <script type="text/javascript" src="lib/jquery/jquery.min.js"></script>

    <!-- Bootstrap -->
    <script type="text/javascript" src="lib/bootstrap/bootstrap.min.js"></script>

    <!-- For D3 (v3) -->
    <script type="text/javascript" src="lib/d3js/d3.min.js" charset="utf-8"></script>

    <!-- For C3 (modified v0.4.22) -->
    <script type="text/javascript" src="lib/c3js/c3.min.js"></script></head>

    <!-- DataTables -->
    <script type="text/javascript" src="lib/datatables/scripts/datatables.js"></script>

    <!-- For keen.io -->
    <script type="text/javascript" src="lib/keen/keen.min.js"></script>
    <script type="text/javascript" src="lib/keen/meta.js"></script>

    <!-- For pretty-json -->
    <script type="text/javascript" src="lib/underscore/underscore-min.js"></script>
    <script type="text/javascript" src="lib/backbone/backbone-min.js"></script>
    <script type="text/javascript" src="lib/pretty-json/pretty-json-min.js"></script>

    <!-- For select2 -->
    <script type="text/javascript" src="lib/select2/select2.min.js"></script>


    <!-- Pipeline output data -->

    <!-- Description of input files and options -->
    <script type="text/javascript" src="assets/summary/js/filesIn.js"></script>

    <!-- Data for chartT1 -->
    <script type="text/javascript" src="assets/summary/js/chartT1.js"></script>

    <!-- Data for chartBOLD -->
    <script type="text/javascript" src="assets/summary/js/chartBOLD.js"></script>

    <!-- DataIntra -->
    <script type="text/javascript" src="assets/summary/js/chartBrain.js"></script>

    <!-- List of subjects -->
    <script type="text/javascript" src="assets/group/js/listSubject.js"></script>

    <!-- List of runs -->
    <script type="text/javascript" src="assets/group/js/listRun.js"></script>

    <!-- Text summary for the pipeline -->
    <script type="text/javascript" src="assets/summary/js/pipeSummary.js"></script>

    <!-- Data for chartFD and chartNbVol -->
    <script type="text/javascript" src="assets/summary/js/fd.js"></script>


    <!-- QC Dashboard scripts -->

    <!-- Dashboard objects -->
    <script type="text/javascript" src="assets/general/js/qc_dash_objects.js"></script>


    <!-- Main script -->
    <script>

        var contents = {

            general: {

                chartHeight: parseFloat(window.innerHeight) / 3,
                tableHeight: parseFloat(window.innerHeight) / 4,
                sigDigits: 4,
            },

            group: {

                generated: false,
            },

            motion: {

                chartManager: null,
                chartNotes: "Click on a bar to highlight run. Double click to open the motion report. Mouse scroll to zoom.",
                generated: false,
                dataDict: null,
                dataTable: null,
                tableInfo: {
                    columns: [["rt-column-id", "id", null],
                              ["rt-column-name", "name", null],
                              ["rt-column-corr_target", "corr_subject_T1", "intra"],
                              ["rt-column-fdbefore", "FD_before_scrubbing", "fd"],
                              ["rt-column-fdafter", "FD_after_scrubbing", "fd"],
                              ["rt-column-volscrubbed", "vol_after_scrubbing", "nbVol"],
                              ["rt-column-volok", "vol_before_scrubbing", "nbVol"]],
                    footers: ["rt-column-footer-id",
                              "rt-column-footer-name",
                              "rt-column-footer-corr_target",
                              "rt-column-footer-fdbefore",
                              "rt-column-footer-fdafter",
                              "rt-column-footer-volscrubbed",
                              "rt-column-footer-volok"]
                }
            },

            provenance: {

                generated: false,
            },

            registration: {

                chartManager: null,
                chartNotes: "Click on a bar to highlight subject. Double click to go to registration QC. Mouse scroll to zoom.",
                generated: false,
                dataDict: null,
                dataTable: null,
                tableInfo: {
                    columns: [["st-column-id", "id", null],
                              ["st-column-name", "name", null],
                              ["st-column-t1corrtarget", "T1 corr template", "t1"],
                              ["st-column-t1overlapbrain", "T1 ovlp template", "overlapT1"],
                              ["st-column-boldcorrtarget", "BOLDref corr template", "bold"],
                              ["st-column-boldoverlapbrain", "BOLDref ovlp template", "brain"]],
                    footers: ["st-column-footer-id",
                              "st-column-footer-name",
                              "st-column-footer-t1corrtarget",
                              "st-column-footer-t1overlapbrain",
                              "st-column-footer-boldcorrtarget",
                              "st-column-footer-boldoverlapbrain"]
                }
            }
        };

        // Functions

        // Data table for subjects
        function createSubjectTable() {

            // Add header, content, and footer to the subject table
            var myTableElement = $("#subjectTable");
            myTableElement.append("<thead><tr>" +
                                  "<th class='st-column-nohighlight' id='" + contents.registration.tableInfo.columns[0][0] + "'>id</th>" +
                                  "<th class='st-column-nohighlight' id='" + contents.registration.tableInfo.columns[1][0] + "'>name</th>" +
                                  "<th id='" + contents.registration.tableInfo.columns[2][0] + "'>T1 corr template</th>" +
                                  "<th id='" + contents.registration.tableInfo.columns[3][0] + "'>T1 ovlp template</th>" +
                                  "<th id='" + contents.registration.tableInfo.columns[4][0] + "'>BOLDref corr template</th>" +
                                  "<th id='" + contents.registration.tableInfo.columns[5][0] + "'>BOLDref ovlp template</th>" +
                                  "</tr></thead><tbody>");
            for ( var textID in contents.registration.dataDict ) {

                let myRow = "<tr class='clickable-row'>" +
                            "<td class='st-row-nohighlight'>" + contents.registration.dataDict[textID].numericID + "</td>" +
                            "<td class='st-row-nohighlight'>" + textID + "</td>" +
                            "<td>" + parseFloat(contents.registration.dataDict[textID].t1.corrTarget).toFixed(contents.general.sigDigits) + "</td>" +
                            "<td>" + parseFloat(contents.registration.dataDict[textID].t1.overlapBrain).toFixed(contents.general.sigDigits) + "</td>" +
                            "<td>" + parseFloat(contents.registration.dataDict[textID].bold.corrTarget).toFixed(contents.general.sigDigits) + "</td>" +
                            "<td>" + parseFloat(contents.registration.dataDict[textID].bold.overlapBrain).toFixed(contents.general.sigDigits) + "</td>" +
                            "</tr>";
                myTableElement.append(myRow);
            }
            myTableElement.append("</tbody><tfoot><tr>" +
                                  "<th id='" + contents.registration.tableInfo.footers[0] + "'>" +
                                  contents.registration.tableInfo.columns[0][1] + "</th>" +
                                  "<th id='" + contents.registration.tableInfo.footers[1] + "'>" + contents.registration.tableInfo.columns[1][1] + "</th>" +
                                  "<th id='" + contents.registration.tableInfo.footers[2] + "'>" + contents.registration.tableInfo.columns[2][1] + "</th>" +
                                  "<th id='" + contents.registration.tableInfo.footers[3] + "'>" + contents.registration.tableInfo.columns[3][1] + "</th>" +
                                  "<th id='" + contents.registration.tableInfo.footers[4] + "'>" + contents.registration.tableInfo.columns[4][1] + "</th>" +
                                  "<th id='" + contents.registration.tableInfo.footers[5] + "'>" + contents.registration.tableInfo.columns[5][1] + "</th>" +
                                  "</tr></tfoot>");

            // Create and configure the subjects table
            //$(document).ready(function() {

                var table = $("#subjectTable").DataTable({

                    columnDefs: [
                        { searchable: false, targets: [0,2,3,4,5] },
                        { width: "10%", targets: [0,1] },
                        { width: "20%", targets: [2,3,4,5] },
                    ],

                    // Paging
                    // lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    // pageLength: 5,

                    // Scrolling
                    scrollY: contents.general.tableHeight,
                    scrollCollapse: true,
                    paging: false,

                    responsive: true,
                    select: true
                });

                $("#subjectTable tbody").on("click", "tr", function() {

                    // alert("You clicked on " + data[1] + "\'s row");
                    contents.registration.chartManager.selectChartData(table.row(this).data()[1]);
                });

                $("#subjectTable tbody").on("click", "tr", function() {
                    $(this).toggleClass("selected");
                });

                // $("#subjectTable thead").on("click", "tr", function() {

                //     // alert("You clicked on " + data[1] + "\'s row");
                //     var data = table.row(this).data();
                //     dashboardCharts.signalChartsFocus(data[1], "subject",
                //                                       ["t1", "bold", "brain"]);
                // });

                // Start with the third column selected
                $("#" + contents.registration.tableInfo.columns[2][0]).click();
                $(".dataTables_scrollFoot " + "#" + contents.registration.tableInfo.footers[2]).addClass("footer-highlight");

                // Save a reference to the data table
                contents.registration.dataTable = table;
            //});

            // Make subject table collapsible
            // $("#subjectTable").collapse();
        }

        // Data table for runs
        function createRunTable() {

            // Add header, content, and footer to the run table
            var myTableElement = $("#runTable");
            myTableElement.append("<thead><tr>" +
                                  "<th class='st-column-nohighlight' id='" + contents.motion.tableInfo.columns[0][0] + "'>"
                                  + contents.motion.tableInfo.columns[0][1] + "</th>" +
                                  "<th class='st-column-nohighlight' id='" + contents.motion.tableInfo.columns[1][0] + "'>"
                                  + contents.motion.tableInfo.columns[1][1] + "</th>" +
                                  "<th id='" + contents.motion.tableInfo.columns[2][0] + "'>"
                                  + contents.motion.tableInfo.columns[2][1] + "</th>" +
                                  "<th id='" + contents.motion.tableInfo.columns[3][0] + "'>"
                                  + contents.motion.tableInfo.columns[3][1] + "</th>" +
                                  "<th id='" + contents.motion.tableInfo.columns[4][0] + "'>"
                                  + contents.motion.tableInfo.columns[4][1] + "</th>" +
                                  "<th id='" + contents.motion.tableInfo.columns[5][0] + "'>"
                                  + contents.motion.tableInfo.columns[5][1] + "</th>" +
                                  "<th id='" + contents.motion.tableInfo.columns[6][0] + "'>"
                                  + contents.motion.tableInfo.columns[6][1] +
                                  "</tr></thead><tbody>");
            for ( var textID in contents.motion.dataDict ) {

                let myRow = "<tr class='clickable-row'>" +
                            "<td class='st-row-nohighlight'>" + contents.motion.dataDict[textID].numericID + "</td>" +
                            "<td class='st-row-nohighlight'>" + textID + "</td>" +
                            "<td>" + parseFloat(contents.motion.dataDict[textID].intra.corrTarget).toFixed(contents.general.sigDigits) + "</td>" +
                            "<td>" + parseFloat(contents.motion.dataDict[textID].fd.before).toFixed(contents.general.sigDigits) + "</td>" +
                            "<td>" + parseFloat(contents.motion.dataDict[textID].fd.after).toFixed(contents.general.sigDigits) + "</td>" +
                            "<td>" + parseFloat(contents.motion.dataDict[textID].nbVol.scrubbed).toFixed(contents.general.sigDigits) + "</td>" +
                            "<td>" + parseFloat(contents.motion.dataDict[textID].nbVol.ok).toFixed(contents.general.sigDigits) + "</td>" +
                            "</tr>";
                myTableElement.append(myRow);
            }
            myTableElement.append("</tbody><tfoot><tr>" +
                                  "<th id='" + contents.motion.tableInfo.footers[0] + "'>" +
                                  contents.motion.tableInfo.columns[0][1] + "</th>" +
                                  "<th id='" + contents.motion.tableInfo.footers[1] + "'>" + contents.motion.tableInfo.columns[1][1] + "</th>" +
                                  "<th id='" + contents.motion.tableInfo.footers[2] + "'>" + contents.motion.tableInfo.columns[2][1] + "</th>" +
                                  "<th id='" + contents.motion.tableInfo.footers[3] + "'>" + contents.motion.tableInfo.columns[3][1] + "</th>" +
                                  "<th id='" + contents.motion.tableInfo.footers[4] + "'>" + contents.motion.tableInfo.columns[4][1] + "</th>" +
                                  "<th id='" + contents.motion.tableInfo.footers[5] + "'>" + contents.motion.tableInfo.columns[5][1] + "</th>" +
                                  "<th id='" + contents.motion.tableInfo.footers[6] + "'>" + contents.motion.tableInfo.columns[6][1] + "</th>" +
                                  "</tr></tfoot>");

            // Create and configure the subjects table
            //$(document).ready(function() {

                var table = $("#runTable").DataTable({

                    columnDefs: [
                        { searchable: false, targets: [0,2,3,4,5] },
                        { width: "10%", targets: [0,1] },
                        { width: "20%", targets: [2,3,4,5] },
                    ],

                    // Paging
                    // lengthMenu: [[5, 10, 25, 50, -1], [5, 10, 25, 50, "All"]],
                    // pageLength: 5,

                    // Scrolling
                    scrollY: contents.general.tableHeight,
                    scrollCollapse: true,
                    paging: false,

                    responsive: true,
                    select: true,
                });

                $("#runTable tbody").on("click", "tr", function() {

                    // alert("You clicked on " + data[1] + "\'s row");
                    contents.motion.chartManager.selectChartData(table.row(this).data()[1]);
                });

                $("#runTable tbody").on("click", "tr", function() {
                    $(this).toggleClass("selected");
                });

                // $("#runTable thead").on("click", "tr", function() {

                //     // alert("You clicked on " + data[1] + "\'s row");
                //     var data = table.row(this).data();
                //     dashboardCharts.signalChartsFocus(data[1], "subject",
                //                                       ["t1", "bold", "brain"]);
                // });

                // Start with the third column selected
                $("#" + contents.motion.tableInfo.columns[2][0]).click();
                $(".dataTables_scrollFoot " + "#" + contents.motion.tableInfo.footers[2]).addClass("footer-highlight");

                // Save a reference to the data table
                contents.motion.dataTable = table;
            //});

            // Make subject table collapsible
            // $("#runTable").collapse();
        }

        // Pill content generation
        function generateGroupContent() {

            if ( !contents.group.generated ) {

                // Group images DOM contents now created and stored in memory
                contents.group.generated = true;
            }
        }

        function generateMotionContent() {

            if ( !contents.motion.generated ) {

                // Motion stats DOM contents now created and stored in memory
                contents.motion.generated = true;

                // Generate and append table for subject data
                createRunTable();

                // Chart object creation

                // constructor(p_data, p_divID, p_xLabel, p_yLabel, p_height, p_clickFn = null,
                //             p_chartTitle = "", p_chartNotes = "", p_subChart = false, p_extents = [0, 25]) {

                // Chart of spatial correlation of individual BOLD data and template
                var chartIntra = new QCDash_BarChart(dataIntra, "chart-motion", "Run",
                                                     "spatial correlation", contents.general.chartHeight,
                                                     selectRun,
                                                     "Spatial correlation with the individual run of reference",
                                                     contents.motion.chartNotes);

                // Chart of frame displacement and number of volumes
                var chartFD = new QCDash_BarChart(dataFD, "chart-motion", "Run", "FD",
                                                  contents.general.chartHeight, selectRun,
                                                  "Impoact of motion censoring on mean FD",
                                                  contents.motion.chartNotes);

                // Chart of #time frames scrubbed vs OK
                var chartNbVol = new QCDash_BarChart(dataNbVol, "chart-motion", "Run", "#time frames",
                                                     contents.general.chartHeight, selectRun,
                                                     "Impoact of motion censoring on available time points",
                                                     contents.motion.chartNotes);

                // Add charts to the motion chart manager
                contents.motion.chartManager.addChart("intra", dataIntra, chartIntra);
                contents.motion.chartManager.addChart("fd", dataFD, chartFD);
                contents.motion.chartManager.addChart("nbVol", dataNbVol, chartNbVol);

                // Generate default chart
                contents.motion.chartManager.generateChart("intra");

                // Assign click events to table columns to generate the charts separately
                for ( let index = 0; index < contents.motion.tableInfo.columns.length; index++ ) {

                    let tableHeaderTag = $("#" + contents.motion.tableInfo.columns[index][0]);
                    let myIndex = index;
                    tableHeaderTag.on("click", function() {

                        if ( null !== contents.motion.tableInfo.columns[index][2] ) {

                            contents.motion.chartManager.generateChart(contents.motion.tableInfo.columns[index][2]);
                        }

                        // Highlight corresponding footer (if not 'id' or 'name' columns)
                        if ( index > 1 ) {

                            $(".dataTables_scrollFoot " + "#" + contents.motion.tableInfo.footers[index]).addClass("footer-highlight");
                        }

                        // Unhighlight all other footers
                        for ( let index2 = 0; index2 < contents.motion.tableInfo.footers.length;
                              index2++ ) {

                            if ( index2 != index ){

                                $(".dataTables_scrollFoot " + "#" + contents.motion.tableInfo.footers[index2]).removeClass();
                            }
                        }
                    });
                }

                // Start with the third column selected
                $("#" + contents.motion.tableInfo.columns[2][0]).click();
                $("#" + contents.motion.tableInfo.footers[2]).addClass("footer-highlight");
            }
        }

        function generateProvenanceContent() {

            if ( !contents.provenance.generated ) {

                // Provenance DOM contents now created and stored in memory
                contents.provenance.generated = true;

                // Summary for the pipeline
                document.getElementById("pipeSummary").innerHTML = pipeSummary;

                // Create button to select subjects
                var filesIn = null;
                $(".select-subject").select2({ data: listSubject });
                $(".select-subject").on("select2:select", function(e) {

                    filesIn = buildFilesIn(e);
                    printFiles(filesIn);
                });

                // Create the json description of initial input files
                let event = {
                    params: {
                        data: {
                            id: "1"
                        }
                    }
                };
                filesIn = buildFilesIn(event);
                printFiles(filesIn);

                // Create the json description of pipeline options
                var node = new PrettyJSON.view.Node({

                    el: $("#prov-pipeline-options-json"),
                    data: opt
                });
                node.expandAll();
            }
        }

        function generateRegistrationContent() {

            if ( !contents.registration.generated ) {

                // Registration stats DOM contents now created and stored in memory
                contents.registration.generated = true;

                // Generate and append table for subject data
                createSubjectTable();

                // Chart object creation

                // Chart of registration quality (spatial correlation) between the T1 scan and the template
                var chartT1 = new QCDash_BarChart(dataT1, "chart-registration",
                                                  "Subject", "spatial correlation",
                                                  contents.general.chartHeight,
                                                  selectSubject,
                                                  "Correlation of individual T1 with template",
                                                  contents.registration.chartNotes);

                // Chart of T1 and template(?) overlap
                var chartOverlapT1 = new QCDash_BarChart(dataOverlapT1,
                                                         "chart-registration",
                                                         "Subject", "% overlap",
                                                         contents.general.chartHeight,
                                                         selectSubject,
                                                         "Overlap between individual and template mask",
                                                         contents.registration.chartNotes);

                // Chart of registration quality (spatial correlation) between the functional scan and the template
                var chartBOLD = new QCDash_BarChart(dataBOLD, "chart-registration", "Subject",
                                                    "spatial correlation", contents.general.chartHeight,
                                                    selectSubject, "Correlation of BOLD with individual T1",
                                                    contents.registration.chartNotes);

                // Chart of brain mask overlap between individual BOLD data and template
                var chartBrain = new QCDash_BarChart(dataBrain, "chart-registration", "Subject",
                                                     "% overlap", contents.general.chartHeight,
                                                     selectSubject,
                                                     "Overlap between individual BOLD mask and group brain mask",
                                                     contents.registration.chartNotes);

                // Add charts to registration chart manager
                contents.registration.chartManager.addChart("t1", dataT1, chartT1);
                contents.registration.chartManager.addChart("overlapT1", dataOverlapT1, chartOverlapT1);
                contents.registration.chartManager.addChart("bold", dataBOLD, chartBOLD);
                contents.registration.chartManager.addChart("brain", dataBrain, chartBrain);

                // Generate default chart
                contents.registration.chartManager.generateChart("t1");

                // Assign click events to table columns to generate the charts separately
                for ( let index = 0; index < contents.registration.tableInfo.columns.length; index++ ) {

                    let tableHeaderTag = $("#" + contents.registration.tableInfo.columns[index][0]);
                    let myIndex = index;
                    tableHeaderTag.on("click", function() {

                        if ( null !== contents.registration.tableInfo.columns[index][2] ) {

                            contents.registration.chartManager.generateChart(contents.registration.tableInfo.columns[index][2]);
                        }

                        // Highlight corresponding footer (if not 'id' or 'name' columns)
                        if ( index > 1 ) {

                            $(".dataTables_scrollFoot " + "#" + contents.registration.tableInfo.footers[index]).addClass("footer-highlight");
                        }

                        // Unhighlight all other footers
                        for ( let index2 = 0; index2 < contents.registration.tableInfo.footers.length;
                              index2++ ) {

                            if ( index2 != index ){

                                $(".dataTables_scrollFoot " + "#" + contents.registration.tableInfo.footers[index2]).removeClass();
                            }
                        }
                    });
                }

                // Start with the third column selected
                $("#" + contents.registration.tableInfo.columns[2][0]).click();
                $("#" + contents.registration.tableInfo.footers[2]).addClass("footer-highlight");
            }
        }

        // Creates pretty-json for filesIn
        function printFiles(p_files) {

            var node2 = new PrettyJSON.view.Node({ el:$("#prov-subject-files-json"), data: p_files, });
            node2.expandAll();
        }

        // Creates links to motion report attached to the bars in chartMotion chartBrain and chartIntra
        function selectRun(p_data, p_chart) {

            let run = p_chart.internal.config.axis_x_categories[p_data.x];
            // let newTab = window.open(["motion_report_" + run + ".html"], "_blank");
            let newTab = window.open(["motion.html?id=" + run], "_blank");

            if ( newTab ) {

                // Browser has allowed it to be opened
                newTab.focus();
            } else {

                // Browser has blocked it
                alert("Please allow popups for this website");
            }
        }

        // Creates links to registration report attached to the bars in chartT1 and chartBOLD
        function selectSubject(p_data, chart) {

            let subject = chart.internal.config.axis_x_categories[p_data.x];
            let newTab = window.open(["registration.html?id=" + subject], "_blank");

            if ( newTab ) {

                // Browser has allowed it to be opened
                newTab.focus();
            } else {

                // Browser has blocked it
                alert("Please allow popups for this website");
            }
        }

        // Main script
        $(document).ready(function() {

            // Data tables

            // Create the subject table and registration stats chart manager
            contents.registration.dataDict = createSubjectDictionary(dataT1, dataOverlapT1, dataBOLD, dataBrain);
            contents.registration.chartManager = new QCDash_Charts(contents.registration.dataDict,
                "chart-title-registration", "chart-notes-registration");

            // Create the subject table and motion stats chart manager
            contents.motion.dataDict = createRunDictionary(dataRun, dataIntra, dataFD, dataNbVol);
            contents.motion.chartManager = new QCDash_Charts(contents.motion.dataDict,
                "chart-title-motion", "chart-notes-motion");

            // Register click events for the navigation pills
            $("#pill-registration-stats").on("click", generateRegistrationContent);
            $("#pill-motion-stats").on("click", generateMotionContent);
            $("#pill-group-images").on("click", generateGroupContent);
            $("#pill-provenance").on("click", generateProvenanceContent);

            // Default view is registration stats
            generateRegistrationContent();

            // Add DataTables column adjust to compensate for hidden Bootstrap nav pills
            $(".nav-pills a").on("shown.bs.tab", function (e) {

                $.fn.dataTable.tables( {visible: true, api: true} ).columns.adjust();
            });
        });

    </script>

</body>

</html>
